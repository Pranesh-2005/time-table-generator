<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Faculty Portal - Amrita Timetable Generator</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    /* Your existing CSS remains the same */
    * {
      font-family: "Poppins", sans-serif;
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      display: flex;
      justify-content: center;
      background-color: #f6f4f7;
      padding: 40px;
    }

    .container {
      background: #fff;
      border-radius: 15px;
      box-shadow: 0px 4px 15px rgba(0, 0, 0, 0.1);
      width: 90%;
      max-width: 1100px;
      padding: 30px 40px;
    }

    .header {
      text-align: center;
      margin-bottom: 25px;
    }

    .header .logo {
      display: inline-block;
      background: #8c1c46;
      color: #fff;
      font-size: 22px;
      font-weight: 600;
      border-radius: 50%;
      width: 45px;
      height: 45px;
      line-height: 45px;
      text-align: center;
      margin-right: 10px;
    }

    .header h1 {
      display: inline-block;
      color: #8c1c46;
      vertical-align: middle;
      font-size: 26px;
    }

    .form-section {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      background: #fdfbfc;
      border: 2px solid #e7d5dc;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 25px;
    }

    .form-group {
      flex: 1 1 45%;
      margin-bottom: 20px;
    }

    label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: #333;
    }

    select,
    input {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
      background: #fff;
      font-size: 15px;
    }

    h2 {
      color: #8c1c46;
      margin-bottom: 12px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      border-radius: 10px;
      overflow: hidden;
    }

    th {
      background: #8c1c46;
      color: #fff;
      padding: 10px;
      text-align: left;
      font-weight: 600;
    }

    td {
      padding: 8px;
      border: 1px solid #ddd;
      vertical-align: top;
    }

    td input,
    td select {
      width: 95%;
      padding: 6px;
      border: 1px solid #ccc;
      border-radius: 5px;
      background-color: #fffdfd;
      font-size: 14px;
    }

    .add-row-btn {
      background-color: #8c1c46;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      margin-top: 15px;
      display: inline-block;
    }

    .add-row-btn:hover {
      background-color: #a02c56;
    }

    .message {
      text-align: center;
      margin: 15px 0;
      font-weight: 600;
    }

    .bottom-buttons {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 25px;
    }

    .bottom-buttons button {
      background-color: #8c1c46;
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
    }

    .bottom-buttons button:hover {
      background-color: #a02c56;
    }

    .consecutive-count {
      display: none;
      margin-top: 5px;
    }

    /* Add styles for data status indicator */
    .data-status {
      text-align: center;
      margin: 10px 0;
      padding: 8px;
      border-radius: 5px;
      font-size: 14px;
    }
    
    .data-saved {
      background-color: #e8f5e8;
      color: #2d5016;
      border: 1px solid #c3e6c3;
    }
    
    .clear-data-btn {
      background-color: #6c757d;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 5px;
      font-size: 14px;
      cursor: pointer;
      margin-left: 10px;
    }
    
    .clear-data-btn:hover {
      background-color: #5a6268;
    }

    /* Remove button styles */
    .remove-btn {
      background-color: #dc3545;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 5px;
      font-size: 12px;
      cursor: pointer;
      width: 100%;
    }

    .remove-btn:hover {
      background-color: #c82333;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <span class="logo">A</span>
      <h1>Amrita Timetable Generator</h1>
    </div>

    <!-- Data status indicator -->
    <div id="dataStatus" class="data-status" style="display: none;">
      <span>Saved data found. Form has been auto-filled.</span>
      <button class="clear-data-btn" onclick="clearSessionData()">Clear Saved Data</button>
    </div>

    <!-- Display server-side errors -->
    {% if error %}
    <div class="message" style="color: red; text-align: center; margin: 15px 0; font-weight: 600;">
      {{ error }}
    </div>
    {% endif %}

    <!-- Form starts -->
    <form action="/generate" method="POST" id="timetableForm" onsubmit="return validateForm()">
      <div class="form-section">
        <div class="form-group">
          <label>Department</label>
          <select name="department" id="department" required>
            <option value="">Select Department</option>
            <option value="CSE">CSE</option>
            <option value="ECE">ECE</option>
            <option value="EEE">EEE</option>
            <option value="MECH">MECH</option>
          </select>
        </div>

        <div class="form-group">
          <label>Semester</label>
          <select name="semester" id="semester" required>
            <option value="">Select Semester</option>
            <option value="Semester 1">Semester 1</option>
            <option value="Semester 3">Semester 3</option>
            <option value="Semester 5">Semester 5</option>
            <option value="Semester 7">Semester 7</option>
          </select>
        </div>

        <div class="form-group">
          <label>Block</label>
          <select name="block" id="block" required>
            <option value="">Select Block</option>
            <option value="AB1">AB1</option>
            <option value="AB2">AB2</option>
            <option value="AB3">AB3</option>
            <option value="AB4">AB4</option>
          </select>
        </div>

        <div class="form-group">
          <label>Classroom</label>
          <select name="classroom" id="classroom" required>
            <option value="">Select Classroom</option>
            <option value="101">101</option>
            <option value="203">203</option>
            <option value="305">305</option>
            <option value="607">607</option>
          </select>
        </div>
      </div>

    
      <div class="message" id="message">Total slots: 0/50</div>
      <table id="courseTable">
        <thead>
          <tr>
            <th>Course Code</th>
            <th>Subject Name</th>
            <th>Faculty Name</th>
            <th>Faculty ID</th>
            <th>Slots per Week</th>
            <th>Consecutive?</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          <!-- Initial empty row -->
          <tr>
            <td><input type="text" name="course_code[]" placeholder="22CSE201"></td>
            <td><input type="text" name="subject_name[]" placeholder="Data Structures"></td>
            <td><input type="text" name="faculty_name[]" placeholder="Priya"></td>
            <td><input type="text" name="faculty_id[]" placeholder="22564"></td>
            <td>
              <select name="slots_per_week[]" onchange="updateTotalSlots()">
                <option value="">Select</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
              </select>
            </td>
            <td>
              <select name="consecutive[]" onchange="toggleConsecutiveCount(this)">
                <option value="">Select</option>
                <option value="Yes">Yes</option>
                <option value="No">No</option>
              </select>
              <select name="consecutive_count[]" class="consecutive-count">
                <option value="">--Select Count--</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
              </select>
            </td>
            <td>
              <button type="button" class="remove-btn" onclick="removeRow(this)">Remove</button>
            </td>
          </tr>
        </tbody>
      </table>

      <button type="button" class="add-row-btn" onclick="addRow()">+ Add Row</button>

      <div class="bottom-buttons">
        <button type="submit">Generate Timetable</button>
      </div>
    </form>
    <!-- Form ends -->
  </div>

  <script>
    let totalSlots = 0;
    const MAX_SLOTS = 50;
    const STORAGE_KEY = 'timetable_form_data';

    // Clear all form data completely
    function clearAllFormData() {
      // Clear basic form fields
      document.getElementById('department').value = '';
      document.getElementById('semester').value = '';
      document.getElementById('block').value = '';
      document.getElementById('classroom').value = '';

      // Clear course table - keep only one empty row
      const tableBody = document.querySelector('#courseTable tbody');
      tableBody.innerHTML = `
        <tr>
          <td><input type="text" name="course_code[]" placeholder="22CSE201"></td>
          <td><input type="text" name="subject_name[]" placeholder="Data Structures"></td>
          <td><input type="text" name="faculty_name[]" placeholder="Priya"></td>
          <td><input type="text" name="faculty_id[]" placeholder="22564"></td>
          <td>
            <select name="slots_per_week[]" onchange="updateTotalSlots()">
              <option value="">Select</option>
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
            </select>
          </td>
          <td>
            <select name="consecutive[]" onchange="toggleConsecutiveCount(this)">
              <option value="">Select</option>
              <option value="Yes">Yes</option>
              <option value="No">No</option>
            </select>
            <select name="consecutive_count[]" class="consecutive-count">
              <option value="">--Select Count--</option>
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
            </select>
          </td>
          <td>
            <button type="button" class="remove-btn" onclick="removeRow(this)">Remove</button>
          </td>
        </tr>
      `;

      // Reset total slots
      totalSlots = 0;
      document.getElementById("message").innerText = `Total slots: ${totalSlots}/${MAX_SLOTS}`;
      

      // Clear session storage
      sessionStorage.removeItem(STORAGE_KEY);
      
      // Hide data status indicator
      document.getElementById('dataStatus').style.display = 'none';
    }

    // Save form data to session storage
    function saveFormData() {
      const formData = {
        department: document.getElementById('department').value,
        semester: document.getElementById('semester').value,
        block: document.getElementById('block').value,
        classroom: document.getElementById('classroom').value,
        courses: []
      };

      // Get all course rows
      const rows = document.querySelectorAll('#courseTable tbody tr');
      rows.forEach(row => {
        const courseCode = row.querySelector('input[name="course_code[]"]').value;
        const subjectName = row.querySelector('input[name="subject_name[]"]').value;
        const facultyName = row.querySelector('input[name="faculty_name[]"]').value;
        const facultyId = row.querySelector('input[name="faculty_id[]"]').value;
        const slotsPerWeek = row.querySelector('select[name="slots_per_week[]"]').value;
        const consecutive = row.querySelector('select[name="consecutive[]"]').value;
        const consecutiveCount = row.querySelector('select[name="consecutive_count[]"]').value;

        // Only save non-empty rows
        if (courseCode || subjectName || facultyName || facultyId) {
          formData.courses.push({
            courseCode,
            subjectName,
            facultyName,
            facultyId,
            slotsPerWeek,
            consecutive,
            consecutiveCount
          });
        }
      });

      sessionStorage.setItem(STORAGE_KEY, JSON.stringify(formData));
    }

    // Load form data from session storage
    function loadFormData() {
      const savedData = sessionStorage.getItem(STORAGE_KEY);
      if (savedData) {
        const formData = JSON.parse(savedData);
        
        // Fill basic form fields
        document.getElementById('department').value = formData.department || '';
        document.getElementById('semester').value = formData.semester || '';
        document.getElementById('block').value = formData.block || '';
        document.getElementById('classroom').value = formData.classroom || '';

        // Fill course rows
        const tableBody = document.querySelector('#courseTable tbody');
        tableBody.innerHTML = ''; // Clear existing rows

        if (formData.courses && formData.courses.length > 0) {
          formData.courses.forEach((course, index) => {
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
              <td><input type="text" name="course_code[]" placeholder="Course Code" value="${course.courseCode || ''}"></td>
              <td><input type="text" name="subject_name[]" placeholder="Subject Name" value="${course.subjectName || ''}"></td>
              <td><input type="text" name="faculty_name[]" placeholder="Faculty Name" value="${course.facultyName || ''}"></td>
              <td><input type="text" name="faculty_id[]" placeholder="Faculty ID" value="${course.facultyId || ''}"></td>
              <td>
                <select name="slots_per_week[]" onchange="updateTotalSlots()">
                  <option value="">Select</option>
                  <option value="1" ${course.slotsPerWeek === '1' ? 'selected' : ''}>1</option>
                  <option value="2" ${course.slotsPerWeek === '2' ? 'selected' : ''}>2</option>
                  <option value="3" ${course.slotsPerWeek === '3' ? 'selected' : ''}>3</option>
                  <option value="4" ${course.slotsPerWeek === '4' ? 'selected' : ''}>4</option>
                </select>
              </td>
              <td>
                <select name="consecutive[]" onchange="toggleConsecutiveCount(this)">
                  <option value="">Select</option>
                  <option value="Yes" ${course.consecutive === 'Yes' ? 'selected' : ''}>Yes</option>
                  <option value="No" ${course.consecutive === 'No' ? 'selected' : ''}>No</option>
                </select>
                <select name="consecutive_count[]" class="consecutive-count" style="${course.consecutive === 'Yes' ? 'display: block;' : 'display: none;'}">
                  <option value="">--Select Count--</option>
                  <option value="1" ${course.consecutiveCount === '1' ? 'selected' : ''}>1</option>
                  <option value="2" ${course.consecutiveCount === '2' ? 'selected' : ''}>2</option>
                  <option value="3" ${course.consecutiveCount === '3' ? 'selected' : ''}>3</option>
                </select>
              </td>
              <td>
                <button type="button" class="remove-btn" onclick="removeRow(this)">Remove</button>
              </td>
            `;
            tableBody.appendChild(newRow);
          });
        } else {
          // Add one empty row if no courses saved
          addRow();
        }

        // Show data status indicator
        document.getElementById('dataStatus').style.display = 'block';
        
        // Update total slots
        updateTotalSlots();
        
        return true;
      }
      return false;
    }

    // Clear session data
    function clearSessionData() {
      clearAllFormData();
    }

    // Add event listeners to save data on input
    function setupAutoSave() {
      // Basic form fields
      document.getElementById('department').addEventListener('change', saveFormData);
      document.getElementById('semester').addEventListener('change', saveFormData);
      document.getElementById('block').addEventListener('change', saveFormData);
      document.getElementById('classroom').addEventListener('change', saveFormData);

      // Course table - delegate events since rows are dynamic
      document.getElementById('courseTable').addEventListener('input', function(e) {
        if (e.target.matches('input, select')) {
          saveFormData();
        }
      });
    }

    // Remove row function - SIMPLIFIED VERSION
    function removeRow(button) {
      const row = button.closest('tr');
      const tableBody = document.querySelector('#courseTable tbody');
      const rows = tableBody.querySelectorAll('tr');
      
      // If there's only one row, clear it instead of removing
      if (rows.length === 1) {
        // Clear all inputs in the row but keep the row
        const inputs = row.querySelectorAll('input');
        const selects = row.querySelectorAll('select');
        
        inputs.forEach(input => input.value = '');
        selects.forEach(select => {
          if (select.name !== 'consecutive_count[]') {
            select.value = '';
          }
        });
        
        // Hide consecutive count dropdown
        const consecutiveCount = row.querySelector('.consecutive-count');
        if (consecutiveCount) {
          consecutiveCount.style.display = 'none';
          consecutiveCount.value = '';
        }
      } else {
        // Remove the row if there are multiple rows
        row.remove();
      }
      
      updateTotalSlots();
      saveFormData();
    }

    function updateTotalSlots() {
      totalSlots = 0;
      const slotInputs = document.querySelectorAll('select[name="slots_per_week[]"]');
      slotInputs.forEach(select => {
        if (select.value) {
          totalSlots += parseInt(select.value);
        }
      });
      
      // Update message with current total
      const messageBox = document.getElementById("message");
      if (totalSlots > MAX_SLOTS) {
        messageBox.innerText = `Total slots (${totalSlots}) exceeds maximum allowed (${MAX_SLOTS})!`;
        messageBox.style.color = "red";
      } else {
        messageBox.innerText = `Total slots: ${totalSlots}/${MAX_SLOTS}`;
        messageBox.style.color = "black";
      }
      
      // Save data when slots are updated
      saveFormData();
      
      return totalSlots <= MAX_SLOTS;
    }

    function toggleConsecutiveCount(selectElement) {
      const countDropdown = selectElement.parentNode.querySelector('.consecutive-count');
      if (selectElement.value === "Yes") {
        countDropdown.style.display = "block";
      } else {
        countDropdown.style.display = "none";
        countDropdown.value = "";
      }
      saveFormData();
    }

    function validateExistingRows() {
      const messageBox = document.getElementById("message");
      messageBox.innerText = "";
      
      // Check only existing filled rows (skip the last empty row if it's being added)
      const rows = document.querySelectorAll("#courseTable tbody tr");
      
      for (let i = 0; i < rows.length; i++) {
        const row = rows[i];
        const inputs = row.querySelectorAll("input");
        const selects = row.querySelectorAll("select");
        
        let isEmptyRow = true;
        
        // Check if this row has any data
        for (let input of inputs) {
          if (input.value.trim() !== "") {
            isEmptyRow = false;
            break;
          }
        }
        
        // If it's not an empty row, validate it
        if (!isEmptyRow) {
          for (let input of inputs) {
            if (input.value.trim() === "") {
              messageBox.innerText = "Please fill all boxes in existing rows first";
              messageBox.style.color = "red";
              return false;
            }
          }
          
          for (let select of selects) {
            if (select.name !== "consecutive_count[]" && select.value === "") {
              messageBox.innerText = "Please fill all boxes in existing rows first";
              messageBox.style.color = "red";
              return false;
            }
          }
        }
      }
      
      // Check total slots
      if (!updateTotalSlots()) {
        return false;
      }
      
      return true;
    }

    function addRow() {
      // Only validate existing filled rows, not the new empty one we're about to add
      if (!validateExistingRows()) {
        return;
      }
      
      // Check if adding another row would exceed max slots
      // We assume minimum 1 slot per new row
      if (totalSlots + 1 > MAX_SLOTS) {
        document.getElementById("message").innerText = `Cannot add more subjects. Maximum ${MAX_SLOTS} slots reached!`;
        document.getElementById("message").style.color = "red";
        return;
      }

      const tableBody = document.getElementById("courseTable").getElementsByTagName("tbody")[0];
      const newRow = document.createElement("tr");
      newRow.innerHTML = `
        <td><input type="text" name="course_code[]" placeholder="Course Code"></td>
        <td><input type="text" name="subject_name[]" placeholder="Subject Name"></td>
        <td><input type="text" name="faculty_name[]" placeholder="Faculty Name"></td>
        <td><input type="text" name="faculty_id[]" placeholder="Faculty ID"></td>
        <td>
          <select name="slots_per_week[]" onchange="updateTotalSlots()">
            <option value="">Select</option>
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
          </select>
        </td>
        <td>
          <select name="consecutive[]" onchange="toggleConsecutiveCount(this)">
            <option value="">Select</option>
            <option value="Yes">Yes</option>
            <option value="No">No</option>
          </select>
          <select name="consecutive_count[]" class="consecutive-count">
            <option value="">--Select Count--</option>
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
          </select>
        </td>
        <td>
          <button type="button" class="remove-btn" onclick="removeRow(this)">Remove</button>
        </td>
      `;
      tableBody.appendChild(newRow);
      
      // Clear the message since we successfully added a row
      document.getElementById("message").innerText = `Total slots: ${totalSlots}/${MAX_SLOTS}`;
  
      
      // Save data after adding row
      saveFormData();
    }

    function validateForm() {
      const messageBox = document.getElementById("message");
      messageBox.innerText = "";
      
      // Check ALL rows including the last one for form submission
      const rows = document.querySelectorAll("#courseTable tbody tr");
      
      // Count how many rows have actual data
      let filledRows = 0;
      rows.forEach(row => {
        const inputs = row.querySelectorAll("input");
        let hasData = false;
        inputs.forEach(input => {
          if (input.value.trim() !== "") {
            hasData = true;
          }
        });
        if (hasData) filledRows++;
      });
      
      // Require at least one filled row
      if (filledRows === 0) {
        messageBox.innerText = "Please add at least one course before submitting";
        messageBox.style.color = "red";
        return false;
      }
      
      // Validate only filled rows
      for (let row of rows) {
        const inputs = row.querySelectorAll("input");
        const selects = row.querySelectorAll("select");
        
        // Check if this row has data
        let hasData = false;
        for (let input of inputs) {
          if (input.value.trim() !== "") {
            hasData = true;
            break;
          }
        }
        
        // Only validate rows that have data
        if (hasData) {
          for (let input of inputs) {
            if (input.value.trim() === "") {
              messageBox.innerText = "Please fill all boxes in rows with data";
              messageBox.style.color = "red";
              return false;
            }
          }
          
          for (let select of selects) {
            if (select.name !== "consecutive_count[]" && select.value === "") {
              messageBox.innerText = "Please fill all boxes in rows with data";
              messageBox.style.color = "red";
              return false;
            }
          }
        }
      }
      
      // Check total slots
      if (!updateTotalSlots()) {
        return false;
      }
      
      return true;
    }

    function viewSavedTimetables() {
      window.location.href = '/saved_timetables';
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
      // Check if we should clear all data (when coming from "Create New Timetable")
      const urlParams = new URLSearchParams(window.location.search);
      const shouldClear = urlParams.get('clear') === 'true';
      
      if (shouldClear) {
        clearAllFormData();
        // Remove the clear parameter from URL
        window.history.replaceState({}, document.title, window.location.pathname);
      } else {
        // Try to load saved data
        const hasSavedData = loadFormData();
        
        // If no saved data, ensure we have at least one row
        if (!hasSavedData) {
          const tableBody = document.querySelector('#courseTable tbody');
          if (tableBody.children.length === 0) {
            addRow();
          }
        }
      }
      
      // Set up auto-save functionality
      setupAutoSave();
      
      // Update total slots display
      updateTotalSlots();
    });
  </script>
</body>
</html>